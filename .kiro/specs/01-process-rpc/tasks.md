# 01-process-rpc: Implementation Tasks

## 1. プロジェクトの初期セットアップとスキーマ定義

-   [ ] 1.1 `cargo` ワークスペースの初期化とクレートの作成
    -   `cargo new --lib core` および `cargo new --bin ui` を実行し、`core` と `ui` クレートをワークスペースに追加する。
    -   プロジェクトルートに `proto` ディレクトリを作成する。
    -   `.gitignore` に `target/` ディレクトリを追加する。
    -   _Requirements: 1.1, 1.2_
-   [ ] 1.2 `Cargo.toml` の依存関係設定
    -   `core` と `ui` クレートの `Cargo.toml` に `tonic`, `prost`, `tokio` などのgRPC関連および認証トークン生成に必要な依存関係を追加する。
    -   _Requirements: 1.1, 1.2, 3.1, 6.1_
-   [ ] 1.3 Protocol Buffers スキーマの定義
    -   `proto/editor.v1.proto` ファイルを作成し、`EditorService` と `Handshake` RPC、および関連するメッセージ (`HandshakeRequest`, `HandshakeResponse`) を定義する。
    -   _Requirements: 3.1, 5.1, 5.3_
-   [ ] 1.4 `tonic-build` によるコード自動生成の設定
    -   `core` と `ui` クレートの `build.rs` を作成し、`tonic-build` を用いて `.proto` からコードが自動生成されるように設定する。
    -   `cargo build` を実行し、gRPC関連のコードが自動生成されることを確認する。
    -   _Requirements: 5.2_

## 2. コアプロセス (サーバー) の実装

-   [ ] 2.1.1 認証トークン検証ロジックの単体テスト実装
    -   認証トークン検証ロジックの単体テストを作成する（正当なトークン、不正なトークン、空のトークンなど）。
    -   _Requirements: 6.1, 6.2_
-   [ ] 2.1.2 認証トークン検証ロジックの実装
    -   `tonic` のインターセプタを用いて、gRPCリクエストのメタデータに含まれる認証トークンを検証する認証レイヤーを実装する。
    -   _Requirements: 6.1, 6.2_
-   [ ] 2.2.1 gRPCサーバーのポート割り当てロジックの単体テスト実装
    -   動的ポート割り当てロジックの単体テストを作成する。
    -   _Requirements: 4.2_
-   [ ] 2.2.2 gRPCサーバーの起動とポート割り当ての実装
    -   `core/src/main.rs` で、標準入力から認証トークンを読み取る処理を実装する。
    -   `core/src/main.rs` で、TCPポート `0` を指定してgRPCサーバーを起動し、実際に割り当てられたポート番号を標準出力に書き出す処理を実装する。
    -   _Requirements: 4.2, 4.3, 6.1_
-   [ ] 2.3.1 `Handshake` RPCサーバーロジックの単体テスト実装
    -   `Handshake` RPCのサーバー側ロジックの単体テストを作成する。
    -   _Requirements: 3.1, 3.2_
-   [ ] 2.3.2 `Handshake` RPCサーバーロジックの実装
    -   `Handshake` RPCのサーバー側ロジックを実装し、クライアントからのメッセージ受信後にメッセージを返す処理を実装する。
    -   _Requirements: 3.1, 3.2_
-   [ ] 2.4 gRPCキープアライブの設定
    -   サーバー側でgRPCキープアライブを有効にする設定を追加し、アイドル時の接続維持を保証する。
    -   _Requirements: 3.4_

## 3. UIプロセス (クライアント) の実装

-   [ ] 3.1.1 認証トークン生成の単体テスト実装
    -   安全なワンタイムトークンが生成されることを確認する単体テストを作成する。
    -   _Requirements: 6.1_
-   [ ] 3.1.2 認証トークン生成の実装
    -   `ui/src/main.rs` で、安全なワンタイムトークンを生成する処理を実装する。
    -   _Requirements: 6.1_
-   [ ] 3.1.3 コアプロセス起動とトークン書き込みの実装
    -   `ui/src/main.rs` で、`std::process::Command` を用いて `core` プロセスを起動し、生成したトークンを `stdin` に書き込む処理を実装する。
    -   _Requirements: 2.1, 6.1_
-   [ ] 3.2 コアプロセスのライフサイクル管理
    -   UIプロセス終了時に、起動した `core` プロセスが確実に終了する処理を実装する。
    -   _Requirements: 2.2_
-   [ ] 3.3.1 gRPCクライアント認証ロジックの単体テスト実装
    -   gRPCクライアント認証ロジックの単体テストを作成する。
    -   _Requirements: 6.3_
-   [ ] 3.3.2 gRPCクライアント接続と認証の実装
    -   `core` プロセスの `stdout` からポート番号を非同期に読み取り、パースする処理を実装する。
    -   取得したポート番号に対しgRPCクライアント接続を行う処理を実装する。
    -   `tonic` のインターセプタまたはリクエスト設定を用いて、すべてのRPCコールに認証トークンをメタデータとして付与する。
    -   _Requirements: 3.1, 4.3, 6.3_
-   [ ] 3.4 `Handshake` RPCクライアントロジックの実装
    -   `Handshake` RPCのクライアント側ロジックを実装し、コアとのメッセージ交換を行う。
    -   _Requirements: 3.1, 3.2_
-   [ ] 3.5 gRPCキープアライブの設定
    -   クライアント側でgRPCキープアライブを有効にする設定を追加し、アイドル時の接続維持を保証する。
    -   _Requirements: 3.4_

## 4. 統合テストとエラーハンドリング

-   [ ] 4.1 正常系統合テスト
    -   UIとコアが正常に起動・接続し、「Hello」メッセージを交換して正常に終了する統合テストを作成する。
    -   _Requirements: 3.1, 3.2_
-   [ ] 4.2 異常系統合テスト
    -   不正なトークンを持つクライアントが接続しようとした場合に、コア側で接続が拒否されることを確認する統合テストを作成する。
    -   UIプロセスが異常終了した場合に、コアプロセスも追随して終了することを確認する統合テストを作成する。
    -   _Requirements: 3.3, 6.2_
-   [ ] 4.3 複数プロセス起動テスト
    -   UIプロセスを2つ同時に起動し、それぞれが問題なく自身のコアプロセスと通信できることを確認する統合テストを作成する。
    -   _Requirements: 4.1_
-   [ ] 4.4 エラーハンドリングの強化
    -   コアプロセス起動失敗、ポート番号取得失敗、gRPC接続失敗など、各フェーズでのエラーを適切にハンドリングし、ログ出力を行う。
    -   _Requirements: 3.3_
