# 01-process-rpc: Implementation Tasks

## 1. プロジェクトの初期セットアップとスキーマ定義

-   [x] 1.1 `cargo` ワークスペースの初期化とクレートの作成
    -   `cargo new --lib core` および `cargo new --bin ui` を実行し、`core` と `ui` クレートをワークスペースに追加する。
    -   プロジェクトルートに `proto` ディレクトリを作成する。
    -   `.gitignore` に `target/` ディレクトリを追加する。
    -   _Requirements: 1.1, 1.2_
-   [x] 1.2 `Cargo.toml` の依存関係設定
    -   `core` と `ui` クレートの `Cargo.toml` に `tonic`, `prost`, `tokio` などのgRPC関連および認証トークン生成に必要な依存関係を追加する。
    -   _Requirements: 1.1, 1.2, 3.1, 6.1_
-   [x] 1.3 Protocol Buffers スキーマの定義
    -   `proto/editor.v1.proto` ファイルを作成し、`EditorService` と `Handshake` RPC、および関連するメッセージ (`HandshakeRequest`, `HandshakeResponse`) を定義する。
    -   _Requirements: 3.1, 5.1, 5.3_
-   [x] 1.4 `tonic-build` によるコード自動生成の設定
    -   `core` と `ui` クレートの `build.rs` を作成し、`tonic-build` を用いて `.proto` からコードが自動生成されるように設定する。
    -   `cargo build` を実行し、gRPC関連のコードが自動生成されることを確認する。
    -   _Requirements: 5.2_

## 2. コアプロセス (サーバー) の実装

-   [x] 2.1.1 認証トークン検証ロジックの単体テスト実装
    -   認証トークン検証ロジックの単体テストを作成する（正当なトークン、不正なトークン、空のトークンなど）。
    -   _Requirements: 6.1, 6.2_
-   [x] 2.1.2 認証トークン検証ロジックの実装
            - `tonic` のインターセプタを用いて、gRPCリクエストのメタデータに含まれる認証トークンを検証する認証レイヤーを実装する。
            - _Requirements: 6.1, 6.2_
        - [x] 2.1.3 (Refactor) 認証インターセプタの最適化
            - `MetadataValue` を初期化時に事前生成しキャッシュすることで、リクエスト毎のパース処理を排除する。
        - [x] 2.1.4 (Refactor) クレート名の変更 (`core` -> `eng-core`)
            - Rust標準ライブラリの `core` との名前衝突を避けるため、クレート名とディレクトリ名を変更する。
        - [x] 2.2.1 gRPCサーバーのポート割り当てロジックの単体テスト実装
            - 動的ポート割り当てロジックの単体テストを作成する。
            - _Requirements: 4.2_
        - [x] 2.2.2 gRPCサーバーの起動とポート割り当ての実装
            - `eng-core/src/main.rs` で、標準入力から認証トークンを読み取る処理を実装する。
            - `eng-core/src/main.rs` で、TCPポート `0` を指定してgRPCサーバーを起動し、実際に割り当てられたポート番号を標準出力に書き出す処理を実装する。
            - _Requirements: 4.2, 4.3, 6.1_
        - [x] 2.2.3 (Fix) gRPCサーバーの起動処理の実装
            - `TcpListener` から取得したストリームを使用して `tonic::transport::Server` を起動し、リクエスト待機状態にする実装を追加する。
                - [x] 2.3.1 `Handshake` RPCサーバーロジックの単体テスト実装
                    - `Handshake` RPCのサーバー側ロジックの単体テストを作成する。
                    - _Requirements: 3.1, 3.2_
                - [x] 2.3.2 `Handshake` RPCサーバーロジックの実装
                    - `Handshake` RPCのサーバー側ロジックを実装し、クライアントからのメッセージ受信後にメッセージを返す処理を実装する。
                    - _Requirements: 3.1, 3.2_
                - [x] 2.4 gRPCキープアライブの設定
                    - サーバー側でgRPCキープアライブを有効にする設定を追加し、アイドル時の接続維持を保証する。
                    - _Requirements: 3.4_
        
        ## 3. UIプロセス (クライアント) の実装
        
        - [x] 3.1.1 認証トークン生成の単体テスト実装
            - 安全なワンタイムトークンが生成されることを確認する単体テストを作成する。
            - _Requirements: 6.1_
        - [x] 3.1.2 認証トークン生成の実装
            - `ui/src/main.rs` で、安全なワンタイムトークンを生成する処理を実装する。
            - _Requirements: 6.1_
        - [x] 3.1.3 コアプロセス起動とトークン書き込みの実装
            - `ui/src/main.rs` で、`std::process::Command` を用いて `core` プロセスを起動し、生成したトークンを `stdin` に書き込む処理を実装する。
            - _Requirements: 2.1, 6.1_
        - [x] 3.2 コアプロセスのライフサイクル管理
            - UIプロセス終了時に、起動した `core` プロセスが確実に終了する処理を実装する。
            - _Requirements: 2.2_
        - [x] 3.3.1 gRPCクライアント認証ロジックの単体テスト実装
            - gRPCクライアント認証ロジックの単体テストを作成する。
            - _Requirements: 6.3_
        - [x] 3.3.2 gRPCクライアント接続と認証の実装
            - `core` プロセスの `stdout` からポート番号を非同期に読み取り、パースする処理を実装する。
            - 取得したポート番号に対しgRPCクライアント接続を行う処理を実装する。
            - `tonic` のインターセプタまたはリクエスト設定を用いて、すべてのRPCコールに認証トークンをメタデータとして付与する。
            - _Requirements: 3.1, 4.3, 6.3_
        - [x] 3.4 `Handshake` RPCクライアントロジックの実装
            - `Handshake` RPCのクライアント側ロジックを実装し、コアとのメッセージ交換を行う。
            - _Requirements: 3.1, 3.2_
        - [x] 3.5 gRPCキープアライブの設定
            - クライアント側でgRPCキープアライブを有効にする設定を追加し、アイドル時の接続維持を保証する。
            - _Requirements: 3.4_

## 4. 統合テストとエラーハンドリング



- [x] 4.1 UIプロセスのテストモード実装 (Headless/Auto-close)

    - UIにコマンドライン引数（例: `--test-mode`）を追加する。

    - テストモード時はウィンドウを表示せず（または最小化）、Core起動→Handshake成功後に自動的に終了コード0で終了するように実装する。

    - _Requirements: 3.1, 3.2_

- [x] 4.2 正常系・複数起動の自動化テストスクリプト

    - テストモードを用いて、単体起動および複数同時起動を行い、全て正常終了することを確認するシェルスクリプト（またはRustテスト）を作成する。

    - _Requirements: 4.1_

- [x] 4.3 異常系ハンドリングの実装と検証

    - **Core起動失敗**: バイナリが見つからない場合のエラーハンドリングを強化し、ユーザーに通知（ログ出力）して終了する。

    - **接続断絶**: 実行中にCoreプロセスが強制終了した場合、KeepAliveまたはチャネルエラーで検知し、UI側で「切断」状態へ遷移する処理を実装する。

    - _Requirements: 3.3, 6.2_

- [x] 4.4 エラーハンドリングの検証テスト

    - 意図的にCoreをkillする、無効なパスを指定するなどのシナリオで、UIがパニックせずにエラーを報告して終了することを確認する手動/自動テスト手順を確立する。

    - _Requirements: 3.3_
