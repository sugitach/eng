# Requirements Document

## Introduction
本ドキュメントは、Emacsユーザーを対象とした次世代エディタの要件を定義します。このエディタは、Emacsの強力な機能と操作性を維持しつつ、現代的な開発環境に適合するパフォーマンス、拡張性、およびユーザーエクスペリエンスを提供することを目的とします。開発言語にはRustを用い、Rust製IDEであるZedのソースコードで流用可能なものは積極的に活用することを検討します。

## Requirements

### Requirement 1: Emacs互換の操作性
**Objective:** Emacsユーザーが既存の知識と習慣を活かしてスムーズに作業できるよう、Emacsの主要なキーバインドと操作モデルを次世代エディタが提供すること。

#### Acceptance Criteria
1. WHEN ユーザーがEmacs標準のキーバインド（カーソル移動、ウィンドウ操作、ファイル操作、リージョン操作等々）を入力したとき THEN 次世代エディタは対応するEmacsのコマンドを実行 SHALL。具体的なキーバインドおよびコマンド名については、設計段階で調査して決定する。
2. IF ユーザーがEmacsのミニバッファに相当する入力インターフェースを使用するとき THEN 次世代エディタはコマンド補完と履歴機能を提供 SHALL。ミニバッファの機能は、ユーザーの視線移動を最小限に抑えるUI/UXで提供される SHALL。
3. WHILE ユーザーがテキストを編集している間 THEN 次世代エディタはEmacsのカーソル移動、マーク、リージョン操作をサポート SHALL。
4. WHERE ユーザーが次世代エディタを起動したとき THEN 次世代エディタはEmacsライクな操作環境を提供 SHALL。ただし、初期画面はEmacsと同一である必要はなく、Emacsのdesktopパッケージの処理をデフォルトで有効にする方向で検討する。

### Requirement 2: 高いカスタマイズ性と拡張性
**Objective:** Emacsユーザーが自身のワークフローに合わせてエディタを深くカスタマイズし、機能を拡張できるよう、柔軟な設定とプログラマブルな拡張メカニズムを次世代エディタが提供すること。

#### Acceptance Criteria
1. WHEN ユーザーが設定ファイルを編集したとき THEN 次世代エディタは設定変更をリアルタイムに反映 SHALL。
2. IF ユーザーが新しい機能を追加したいとき THEN 次世代エディタは拡張用言語による機能追加の簡便性を提供 SHALL。ただし、拡張言語はElispに限定されず、既存のEmacs拡張資産の再利用は意図しない。
3. WHILE 次世代エディタが実行されている間 THEN ユーザーは実行中のエディタに対して動的に機能をロード・アンロードできる SHALL。
4. WHERE ユーザーが拡張機能を開発する際 THEN 次世代エディタはデバッグツールとドキュメントを提供 SHALL。

### Requirement 3: 現代的なパフォーマンスと安定性
**Objective:** 大規模なプロジェクトや複雑な操作においても、次世代エディタが高速かつ安定して動作し、現代的な開発環境の要求に応えること。

#### Acceptance Criteria
1. WHEN 大規模なファイルを開いたとき THEN 次世代エディタはZedの最新安定版のパフォーマンスベンチマーク結果を基準とした取り扱い可能なファイルサイズと速度目標でファイルをロードし表示 SHALL。
2. IF ユーザーが検索・置換操作を実行したとき THEN 次世代エディタはZedの最新安定版のパフォーマンスベンチマーク結果を基準とした速度目標で高速なインクリメンタル検索と置換機能を提供 SHALL。
3. WHILE ユーザーが長時間作業している間 THEN 次世代エディタはメモリリークやクラッシュなしに安定して動作 SHALL。
4. WHERE ユーザーが複数のファイルを同時に開いているとき THEN 次世代エディタは各ファイルの変更を効率的に管理し、パフォーマンスを維持 SHALL。

### Requirement 4: 統合開発環境 (IDE) 機能
**Objective:** 次世代エディタが、コード補完、デバッグ、バージョン管理統合など、現代のIDEに求められる主要な機能を提供し、開発者の生産性を向上させること。

#### Acceptance Criteria
1. WHEN ユーザーがコードを入力しているとき THEN 次世代エディタは言語に応じたスマートなコード補完とスニペット機能を提供 SHALL。
2. IF ユーザーがデバッグセッションを開始したとき THEN 次世代エディタはブレークポイント設定、ステップ実行、変数検査機能を提供 SHALL。
3. WHILE ユーザーがGitリポジリ内で作業している間 THEN 次世代エディタはGitステータスの表示、コミット、ブランチ操作などの基本的なバージョン管理機能を提供 SHALL。
4. WHERE ユーザーがプロジェクトファイルを操作する際 THEN 次世代エディタはツリービュー形式のファイルブラウザとプロジェクト管理機能を提供 SHALL。

### Requirement 5: Emacsの主要な利便性の維持と現代的な操作性の融合
**Objective:** Emacsユーザーが慣れ親しんだ操作性や概念を次世代エディタでも継続して利用しつつ、現代的なGUI OSの利便性も享受できるよう、主要な利便性を維持・融合すること。

#### Acceptance Criteria
1. WHEN ユーザーがキーバインドを設定するとき THEN 次世代エディタは標準的なキーバインドの変更および高度なカスタマイズを可能にする SHALL。
2. IF ユーザーが操作をキャンセルしたいとき THEN 次世代エディタはCtrl-g (quit) コマンドによるあらゆる操作のキャンセル機能を提供 SHALL。
3. WHILE 次世代エディタが動作している間 THEN 次世代エディタはコンソールおよびGUIウィンドウのどちらでも動作する利便性を提供 SHALL。
4. WHERE ユーザーがリモートファイルやプロセスを操作する際 THEN 次世代エディタはtrampモジュールで実行できたようなネットワーク越しのファイルおよびプロセス操作機能を提供 SHALL。
5. IF 次世代エディタがペインを管理するとき THEN 次世代エディタはバッファ、ウィンドウ、ペインの3層構造の概念を維持 SHALL。ただし、それぞれの名称は現代的に変更する（frame → window, window → pane, buffer そのまま）。
6. WHEN テキストプロパティを扱うとき THEN 次世代エディタはZedの実装を調査し参考にできるところを取り込み、fontの各属性(family, size, stretch, style, height)、color, background-color, border (text に対する border のみ), white-space (折り返し表示が有効な場合のみ)といったCSS1〜2.1あたりのテキスト表現を包含できることが望ましい SHALL。
7. IF Undo/Clipboard操作を行うとき THEN 次世代エディタはEmacsよりも現代的なGUI OSのプリミティブな仕様に寄せる SHALL。ただし、複数の履歴の保持と利用、履歴の循環利用、履歴の永続化とOSのクリップボードとの連携機能を維持する（優先度高）SHALL。また、マネージャ機能を追加してエントリの追加、削除、順序の入れ換え等の編集機能を持たせる（優先度低）SHALL。

### Requirement 6: 分散型アーキテクチャと多様なUIサポート
**Objective:** 現代的な開発環境の要求に応えるため、UIとエディタコアの分離、および多様なUI環境への対応を実現すること。詳細は `01-process-rpc` SPECで定義する。

#### Acceptance Criteria
1. WHEN 次世代エディタが起動するとき THEN UIとエディタコアが分離されたアーキテクチャで動作 SHALL。
2. WHILE ユーザーが次世代エディタを利用している間 THEN UIはターミナル、ネイティブGUI、Webブラウザなど多様な環境に対応 SHALL。

### Requirement 7: 開発技術スタック
**Objective:** 高いパフォーマンスと安定性を実現し、現代的な開発エコシステムに適合するため、適切な開発言語と既存資産の活用を行うこと。

#### Acceptance Criteria
1. WHEN 次世代エディタを開発するとき THEN 開発言語にはRustを用いる SHALL。
2. IF 開発において既存の資産を活用する際 THEN Rust製IDEであるZedのソースコードで流用可能なものは積極的に流用 SHALL。

### Requirement 8: 機能拡張用言語の選定要件
**Objective:** ユーザーがエディタの機能を容易に拡張できるよう、適切な機能拡張用言語を選定するための明確な基準を設けること。

#### Acceptance Criteria
1. WHEN 機能拡張用言語を選定するとき THEN 以下の要件を満たす SHALL。
    a. インタプリタ、または、JITコンパイラを備えていて、エディタ起動後にソースコードを読み取って実行できること。
    b. 正規表現を含むテキスト処理が簡易であること。
    c. ガベージコレクション等、機能拡張開発者が意識しなくていいことは極力意識しないで済むこと。
    d. 言語処理系として十分に枯れていて安定していること。
    e. Rust処理系への組み込みが必要以上に複雑にならないこと。
    f. 処理系のフットプリント、速度、機能性など様々な要因を総合的に勘案して決定する SHALL。
2. IF 機能拡張用言語を選定する際 THEN JavaScript, Perl, Python, Ruby, Lua などを候補として検討 SHALL。

### Requirement 9: Emacs主要パッケージ機能の統合
**Objective:** Emacsユーザーにとって不可欠な主要パッケージの機能を次世代エディタに統合し、開発ワークフローをサポートすること。

#### Acceptance Criteria
1. WHEN ファイル管理を行うとき THEN 次世代エディタはdiredと同等の機能を提供 SHALL。（最優先）
2. WHEN ファイルやコードの差分を比較・マージするとき THEN 次世代エディタはediffと同等の機能を提供 SHALL。
3. WHEN Gitリポジトリを操作するとき THEN 次世代エディタはmagitと同等の機能を提供 SHALL。

### Requirement 10: 拡張言語に必要な追加要件
**Objective:** 拡張言語がエディタの機能を最大限に引き出し、柔軟なカスタマイズを可能にするための技術的要件を定義すること。

#### Acceptance Criteria
1. WHEN 拡張言語を選定するとき THEN OSのコア機能やAPIにアクセスしやすいこと SHALL。ただし、セキュリティ要件も考慮し、詳細は要検討とする。
2. WHEN 拡張言語がプロセスを扱うとき THEN プロセスを扱えること SHALL。
3. WHEN 拡張言語がスレッドを扱うとき THEN スレッドを扱えること MAY。

### Requirement 11: 入力ソース管理
**Objective:** ユーザーがエディタ内で複数の入力言語や入力方式をスムーズに切り替えられるようにすること。

#### Acceptance Criteria
1. WHEN ユーザーがテキストを入力するとき THEN 次世代エディタは入力ソース (FEP, IM など) の切り替え機能をサポート SHALL。

### Requirement 12: 国際化対応 (i18n)
**Objective:** UIが複数の言語に対応し、多様なユーザーベースに適合できるようにすること。

#### Acceptance Criteria
1. WHEN UIを表示するとき THEN 次世代エディタはメニューやメッセージの切り替えなど、複数の言語に容易に対応できる機構を持つ SHALL。
2. IF 右から左へ書く言語に対応するとき THEN その対応は優先度を低くする SHALL。

### Requirement 13: 文字コードとバイナリファイルの扱い
**Objective:** 多様な文字コードのファイルやバイナリファイルを適切に扱い、ユーザーが編集できるようにすること。

#### Acceptance Criteria
1. WHEN UNICODE以外の文字コードのファイルを扱うとき THEN 次世代エディタは入出力時の変換のみを行い、直接の編集には対応しない SHALL。
2. WHEN バイナリファイルを編集するとき THEN 次世代エディタはEmacsのバイナリモードと同等のレベルでバイナリファイルをそのまま編集するモードを備える SHALL。
3. WHEN Unicodeファイルを扱うとき THEN 次世代エディタはUTF-8をネイティブサポート SHALL。それ以外のUnicodeエンコードについては当面UNICODE以外の文字コードと同等の扱いとする SHALL。

### Requirement 14: AI Agent 対応
**Objective:** エディタがAI Agentとの連携をサポートし、開発者の生産性向上や作業効率化に貢献すること。

#### Acceptance Criteria
1. WHEN ユーザーがAI Agentを利用するとき THEN 次世代エディタはAI Agentとの連携をサポート SHALL。
2. IF AI Agentがコード生成、コードレビュー、デバッグ支援、質問応答などのタスクを実行するとき THEN 次世代エディタはこれらのタスクをAI Agentに実行させる機能を提供 SHALL。
3. WHILE ユーザーがAI Agentとインタラクションしている間 THEN 次世代エディタはユーザーが自然に利用できるUI/UXでAI Agentとのインタラクションを提供 SHALL。
4. WHERE AI Agentがコードやファイルの内容にアクセスする際 THEN 次世代エディタはセキュリティとプライバシーを考慮したアクセス制御メカニズムを提供 SHALL。

### Requirement 15: Emacs Lispトランスレータ
**Objective:** 既存のEmacs Lisp資産を次世代エディタの拡張言語で利用可能にするためのツールを提供すること。

#### Acceptance Criteria
1. WHEN Emacs Lispコードを次世代エディタの拡張言語で利用したいとき THEN 次世代エディタはEmacs Lispから当該開発物の拡張言語へのトランスレータを提供 SHALL。（優先度低）

### Requirement 16: モードとキーマップ管理
**Objective:** Emacsと同様の柔軟なキーバインド管理を実現するため、メジャーモード、マイナーモード、および継承可能なキーマップの仕組みを次世代エディタが提供すること。

#### Acceptance Criteria
1. WHEN バッファにモードが設定されたとき THEN 次世代エディタはEmacsと同様にメジャーモードと複数のマイナーモードの概念をサポートし、モードごとに対応するキーマップが適用される SHALL。
2. IF 新しいキーマップを定義するとき THEN 次世代エディタは既存のキーマップを親として継承し、差分（キーバインドの追加、変更、削除）を定義することで新しいキーマップを作成できる機能を提供 SHALL。
3. WHILE バッファがアクティブな間 THEN 複数のキーマップ（グローバル、メジャーモード、マイナーモードなど）が優先順位に従って同時に適用可能である SHALL。
4. WHERE キー入力が発生したとき THE キーシーケンスから実行すべきコマンドへの変換をどのレイヤー（UI or エディタコア）で行うかは、それぞれの長所と短所を考慮して設計段階で決定される SHALL。

### Requirement 17: インクリメンタルサーチ
**Objective:** Emacsと同等の強力でインタラクティブなインクリメンタルサーチ機能を提供し、ユーザーが効率的にテキストを検索できるようにすること。

#### Acceptance Criteria
1. WHEN ユーザーが検索開始のキーバインド（例: `C-s`, `C-r`）を入力したとき THEN エディタはインクリメンタルサーチモードを開始 SHALL。
2. WHILE インクリメンタルサーチ中にユーザーが文字を入力するたび THEN エディタは即座に次の一致箇所をハイライトし、カーソルを移動させる SHALL。
3. IF 検索中にユーザーが再度検索キーバインドを入力した場合 THEN 次（または前）の一致箇所に移動する SHALL。
4. WHERE ユーザーが検索を終了（例: `Enter`）またはキャンセル（例: `C-g`）したとき THEN エディタはインクリメンタルサーチモードを終了し、カーソルは適切な位置（終了位置または検索開始位置）に留まる SHALL。
5. IF ユーザーが正規表現検索を望む場合 THEN 正規表現によるインクリメンタルサーチもサポート SHALL。

### Requirement 18: キーマクロ
**Objective:** 一連のキー操作を記録・再生するキーマクロ機能を提供し、繰り返し作業を自動化できるようにすること。

#### Acceptance Criteria
1. WHEN ユーザーが記録開始のキーバインド（例: `C-x (`）を入力したとき THEN それ以降のキー操作の記録が開始される SHALL。
2. IF ユーザーが記録終了のキーバインド（例: `C-x )`）を入力したとき THEN マクロの記録が停止し、一連の操作が保存される SHALL。
3. WHILE ユーザーが再生のキーバインド（例: `C-x e`）を入力したとき THEN 最後に記録されたマクロが正確に実行される SHALL。
4. WHERE ユーザーがマクロを永続化したいとき THEN マクロに名前を付けて保存し、後で再利用できる機能を提供する SHALL。

### Requirement 19: リモート開発サポート
**Objective:** SSHなどを経由してリモートホスト上のファイルをシームレスに編集できる機能を提供すること。詳細は `01-process-rpc` SPECで定義する。

#### Acceptance Criteria
1. WHEN ユーザーがリモートホストに接続するとき THEN クライアントはリモートホスト上でエディタのバックエンドプロセスを起動し、通信を確立 SHALL。
